/**
 * JavaScript handles all form actions
 *
 * @author   Max Matloka (max@matloka.me)
 * @since    1.0.0
 * 
 * @package  pagebox/src/public/js
 */

!function(){"use strict";jQuery.fn.pagebox_post=function(){var b,a=jQuery(this),c=jQuery('[data-setting="type"]',a),d=jQuery('[data-setting="post"]',a),e=jQuery('[data-setting="page"]',a),f=jQuery('[data-setting="category"]',a),g=jQuery('[data-setting="tag"]',a),h=jQuery('[data-setting="order"]',a),i=jQuery('[data-setting="orderby"]',a),j=jQuery('[data-setting="offset"]',a),a=jQuery(this),k=function(){jQuery(a).find("tr").not(".subelement-type").hide(),"post"==c.val()?jQuery(a).find('[data-type="post"]').show():"page"==c.val()&&jQuery(a).find('[data-type="page"]').show()},l=function(){jQuery(a).find('[data-type="post"]').not(".subelement-post").hide(),""==d.val()&&jQuery(a).find('[data-type="post"]').not(".subelement-post").show()},m=function(a){clearTimeout(b),b=window.setTimeout(function(){a.apply()},2e3)},n=function(){m(function(){var b={action:"count_posts",type:c.val(),post:d.val(),page:e.val(),category:f.val(),tag:g.val(),order:h.val(),orderby:i.val(),offset:j.val()};jQuery.ajax({url:ajaxurl,type:"post",data:b,success:function(b){jQuery(".found",a).html(b)}})})};jQuery(a).on("change",".subelement-post",function(){l()}),jQuery(a).on("change",".subelement-type",function(){k()}),jQuery(a).on("change",'[data-type="post"]',function(){n()}),k(),l(),n()},jQuery.fn.pagebox_colorpicker=function(){var a=jQuery(this).find("input");jQuery(a).wpColorPicker()},jQuery.fn.pagebox_repeater=function(){var a=jQuery(this),b=function(){c(),jQuery(a).find(".iterator table").each(function(a){var b=/([a-zA-Z0-9-_]+)\[(\d{0,3})\]\[([a-zA-Z0-9-_]+)\]/gm,c="$1["+a+"][$3]";jQuery(this).find(".subelement").each(function(){var a=jQuery(this).attr("name").replace(b,c);jQuery(this).attr("name",a)})})},c=function(){1==jQuery(a).find(".iterator table").length?jQuery('.pagebox[data-action="repeater_remove"]').hide():jQuery('.pagebox[data-action="repeater_remove"]').show()};return jQuery(a).find(".iterator").sortable({items:"table",update:function(){b()},start:function(a,b){b.placeholder.height(b.item.height())}}),c(),jQuery(a).on("click",'.pagebox[data-action="repeater_add"]',function(c){c.preventDefault();var d=jQuery(this).parents(".element-repeater").find('.pagebox[data-action="repeater_boilerplate"]'),e=jQuery.parseJSON(jQuery(d).val()),f=jQuery(a).find(".iterator table").length,g=/([a-zA-Z0-9-_]+)\[(\d{0,3})\]\[([a-zA-Z0-9-_]+)\]/gm,h="$1["+f+"][$3]";e=e.replace(g,h),jQuery(this).parents().eq(3).after("<table>"+e+"</table>"),b(),jQuery(a).find(".iterator").sortable("refresh")}),jQuery(a).on("click",'.pagebox[data-action="repeater_remove"]',function(a){a.preventDefault(),jQuery(this).parents().eq(3).wrap('<div style="display: block;" />').parent().slideUp("slow",function(){jQuery(this).remove(),b()})}),this},jQuery.fn.pagebox_form=function(){jQuery(".element-repeater",this).pagebox_repeater(),jQuery(".element-post",this).pagebox_post(),jQuery('[data-element="colorpicker"]',this).pagebox_colorpicker();var a;jQuery(this).on("click",'.pagebox[data-action="image_upload"]',function(b){b.preventDefault();var d=(jQuery(this),jQuery(this).prev()),e=jQuery(this).next();return a?(a.open(),void 0):(a=wp.media.frames.fileFrame=wp.media({multiple:!1}),a.on("select",function(){var b=a.state().get("selection").first().toJSON();jQuery(e).val(b.id),jQuery(d).html('<img src="'+b.sizes.thumbnail.url+'" alt="" />')}),a.open(),void 0)})}}(jQuery);